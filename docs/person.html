<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Person Details</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    background-color: #fafafa;
    color: #222;
  }
  h1 { text-align: center; margin-bottom: 0.2em; }
  .info, .bio {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  img.main-photo {
    display: block;
    margin: 20px auto;
    max-width: 200px;
    border-radius: 50%;
    border: 3px solid #ccc;
  }
  /* GALLERY STYLES */
  .gallery {
    margin-top: 20px;
  }
  .gallery img {
    display: block;
    width: 100%;
    height: auto;
    margin: 10px auto;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .gallery img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }

  /* Small grid layout */
  .gallery.small {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }
  .gallery.small img {
    width: 100%;
    max-width: none;
  }

  /* Large layout (like original) */
  .gallery.large img {
    display: block;
    max-width: 100%;
  }

  #mini-tree {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 300px;
    height: 200px;
    border: 1px solid #ccc;
    background: #fafafa;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
  .relation-link { text-decoration: none; }
  .relation-link:hover { text-decoration: underline; cursor: pointer; }
  button.toggle-btn {
    margin: 15px 0;
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #0066cc;
    background: #f0f8ff;
    color: #0066cc;
    cursor: pointer;
  }
  button.toggle-btn:hover { background: #e0f0ff; }
</style>
</head>
<body>

<h1 id="name">Loading...</h1>
<img id="main-photo" class="main-photo" src="" alt="Photo">
<p id="birth-death" style="text-align:center; font-size:0.9em; color:#555;"></p>

<div class="info" id="info"></div>

<div class="bio">
  <h2>Biography</h2>
  <div id="bio-text">Loading...</div>
  <button class="toggle-btn" id="toggle-bio" style="display:none;">Показать биографию полностью</button>
  
  <div class="gallery" id="bio-images"></div>
  <button class="toggle-btn" id="toggle-image-size" style="display:none;">Увеличить изображения</button>
  
  <div id="pdf-link"></div>
</div>

<svg id="mini-tree"></svg>

<script src="js/d3.v7.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const rawId = params.get('id');
  if (!rawId) { document.body.innerHTML = "<h2>No person ID specified.</h2>"; return; }
  const personId = rawId.replace(/^id/i, "");
  if (!/^\d+$/.test(personId)) { document.body.innerHTML = "<h2>Invalid person ID.</h2>"; return; }

  fetch('data/family_data.json')
    .then(res => res.json())
    .then(allPeople => {
      const person = allPeople.find(p => p.PersonID.toString() === personId);
      if (!person) { document.body.innerHTML = `<h2>No person with ID ${personId} found.</h2>`; return; }

      const folderId = `id${person.PersonID}_${person.Name.toLowerCase()}`;

      // Header and photo
      document.getElementById('name').textContent = `${person["Name-ru"] || person.Name} ${person["LastName-ru"] || ""}`;
      const mainPhoto = document.getElementById('main-photo');
      mainPhoto.src = person.Photo && person.Photo !== "" ? `images/${person.Photo}` : "https://placehold.co/200x200?text=No+Photo";

      // Birth/Death
      function parseDate(str) {
        if (!str || typeof str !== "string" || str === "?") return null;
        const parts = str.split(".");
        if (parts.length !== 3) return null;
        return new Date(+parts[2], parts[1]-1, +parts[0]);
      }
function calculateAge(birth, death) {
    const birthDate = parsePartialDate(birth);
    const endDate = death ? parsePartialDate(death) : new Date();

    if (!birthDate || !endDate) {
        // Safe fallback if date is invalid
        return "";
    }

    let age = endDate.getFullYear() - birthDate.getFullYear();

    // Adjust age if month and day are known
    if (birthDate._hasMonth && birthDate._hasDay) {
        const m = endDate.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && endDate.getDate() < birthDate.getDate())) age--;
    }

    return age;
}

/**
 * Safely parses partial dates like "14.06.1925", "1894", "02.12.?".
 * Returns null if the year is missing or input is invalid.
 */
function parsePartialDate(dateInput) {
    if (!dateInput) return null;

    // Ensure we are working with a string
    const dateStr = String(dateInput).trim();
    if (!dateStr) return null;

    // Remove unknown placeholders like "?"
    const cleaned = dateStr.replace(/\?/g, "");

    // Split by dot
    const parts = cleaned.split(".").map(p => parseInt(p, 10)).filter(p => !isNaN(p));

    let day = 1, month = 0, year;

    if (parts.length === 3) {
        day = parts[0];
        month = parts[1] - 1;
        year = parts[2];
    } else if (parts.length === 2) {
        day = parts[0];
        month = parts[1] - 1;
        year = null; // cannot calculate age without year
    } else if (parts.length === 1) {
        year = parts[0];
    } else {
        return null;
    }

    if (!year) return null; // must have a year to calculate age

    const date = new Date(year, month, day);
    date._hasMonth = parts.length > 1;
    date._hasDay = parts.length > 2;

    return date;
}


      function pluralizeYears(age) {
  if (typeof age !== "number" || isNaN(age)) return "";
  const lastTwo = age % 100;
  const lastDigit = age % 10;
  if (lastTwo >= 11 && lastTwo <= 14) return `${age} лет`;
  if (lastDigit === 1) return `${age} год`;
  if (lastDigit >= 2 && lastDigit <= 4) return `${age} года`;
  return `${age} лет`;
}


      const isAlive = !person.DeathDate || (typeof person.DeathDate === "string" && person.DeathDate.trim() === "");
      const age = calculateAge(person.BirthDate, person.DeathDate);
      document.getElementById('birth-death').textContent = isAlive
  ? `${person.BirthDate || "?"} (${age ? pluralizeYears(age) : ""})`
  : `${person.BirthDate || "?"} – ${person.DeathDate || "?"} (${age ? pluralizeYears(age) : ""})`;


      // Relatives
      function getNameById(id) {
        if (!id) return "—";
        const p = allPeople.find(x => x.PersonID.toString() === id.toString());
        if (!p) return id;
        const firstName = p["Name-ru"] || p.Name;
        const fullName = `${p["Name-ru"] || p.Name} ${p["LastName-ru"] || ""}`.trim();
        return `<a href="?id=${p.PersonID}" title="${fullName}" class="relation-link">${firstName}</a>`;
      }
      const fatherName  = getNameById(person.FatherID);
      const motherName  = getNameById(person.MotherID);
      const partnerNames = (person.PartnerID || "—").toString().split(",").map(id=>getNameById(id.trim())).join(", ");
      const childNames = (person.ChildID || "—").toString().split(",").map(id=>getNameById(id.trim())).join(", ");
      const siblingNames = (person.SiblingID || "—").toString().split(",").map(id=>getNameById(id.trim())).join(", ");
      document.getElementById('info').innerHTML = `
        <p><strong>Место рождения:</strong> ${person.PlaceBirth || "Unknown"}</p>
        <p><strong>${isAlive ? "Сейчас живет" : "Место упокоения"}:</strong> ${isAlive ? (person.PlaceNow || "—") : (person.PlaceNow || "—")}</p>
        <p><strong>About:</strong> ${person.About || "—"}</p>
        <p><strong>Отец:</strong> ${fatherName} | <strong>Мать:</strong> ${motherName}</p>
        <p><strong>Братья и сестры:</strong> ${siblingNames}</p>
        <p><strong>${person.Gender === "M" ? "Жена" : "Муж"}:</strong> ${partnerNames}</p>
        <p><strong>Дети:</strong> ${childNames}</p>
      `;

      // Bio + toggle
      const bioTextDiv = document.getElementById('bio-text');
      const bioImagesDiv = document.getElementById('bio-images');
      const toggleBioBtn = document.getElementById('toggle-bio');
      const toggleImageSizeBtn = document.getElementById('toggle-image-size');
      let fullText = "", shortText = "", showingFull = false;
      let largeImages = false;

      function renderBio(txt) {
        bioTextDiv.innerHTML = "";
        const container = document.createElement("div");
        container.style.padding = "20px";
        container.style.background = "#fff";
        container.style.borderRadius = "12px";
        container.style.boxShadow = "0 2px 10px rgba(0,0,0,0.1)";
        container.style.marginBottom = "20px";
        bioTextDiv.appendChild(container);

        txt.split(/\n+/).forEach(line=>{
          const trimmed = line.trim();
          if (!trimmed) return;
          let el;
          if (trimmed.startsWith(">")) {
            el = document.createElement("blockquote");
            el.textContent = trimmed.slice(1).trim();
            el.style.margin = "1em 0";
            el.style.paddingLeft = "1em";
            el.style.borderLeft = "3px solid #ccc";
            el.style.color = "#555";
            el.style.fontStyle = "italic";
          } else if (trimmed.length < 20 || trimmed.endsWith(":")) {
            el = document.createElement("h2");
            el.textContent = trimmed;
            el.style.marginTop = "1.5em";
            el.style.marginBottom = "0.5em";
            el.style.fontSize = "1.4em";
          } else {
            el = document.createElement("p");
            el.textContent = trimmed;
            el.style.marginBottom = "1em";
            el.style.lineHeight = "1.6";
            el.style.textAlign = "justify";
          }
          container.appendChild(el);
        });
      }

      // Load TXT
      fetch(`bio/${folderId}/${folderId}.txt`)
        .then(r=>r.ok ? r.text() : "")
        .then(txt=>{
          fullText = txt || "No biography text available.";
          shortText = fullText.split("\n").slice(0,3).join("\n");
          renderBio(shortText);
          if(fullText.split("\n").length>3) toggleBioBtn.style.display = "inline-block";
        }).catch(()=>{ fullText = "No biography text found."; renderBio(fullText); });

      toggleBioBtn.addEventListener("click", ()=>{
        showingFull = !showingFull;
        toggleBioBtn.textContent = showingFull ? "Показать биографию кратко" : "Показать биографию полностью";
        renderBio(showingFull ? fullText : shortText);
        setTimeout(()=>loadMiniTree(allPeople, personId),50);
      });

      // Load gallery images
    // Load gallery images and videos (MODIFIED BLOCK)
      fetch(`bio/${folderId}/${folderId}.json`)
        .then(r=>r.ok ? r.json() : {})
        .then(data=>{
          const images = data.images || [];
          
          // Assuming video files are also listed in the 'images' array,
          // we'll iterate through the single 'images' array and check the extension.
          // If you modify your JSON to use a separate 'videos' key, 
          // you'd combine both arrays here. For now, we'll keep the JSON simple:
          
          const allMedia = images; // We'll use the 'images' array for all files

          bioImagesDiv.innerHTML = allMedia.length===0 ? "<p>No additional images or videos.</p>" : "";

          allMedia.forEach(f=>{
            const filePath = `bio/${folderId}/${f}`;
            const extension = f.split('.').pop().toLowerCase();
            const isVideo = ['mp4', 'webm', 'ogg'].includes(extension);

            if (isVideo) {
              const video = document.createElement("video");
              video.src = filePath;
              video.controls = true; // Essential for playback control
              video.style.display = "block";
              video.style.width = "100%";
              video.style.maxWidth = "600px"; // Optional: prevent massive videos on large screens
              video.style.height = "auto";
              video.style.margin = "10px auto";
              video.style.borderRadius = "8px";
              video.style.border = "1px solid #ddd"; // To match image styling

              bioImagesDiv.appendChild(video);

            } else {
              const img = document.createElement("img");
              img.src = filePath;
              img.alt = "Gallery Image";
              img.onclick = ()=>window.open(img.src,"_blank");
              bioImagesDiv.appendChild(img);
            }
          });

          if (allMedia.length > 0) {
            bioImagesDiv.classList.add("small");
            toggleImageSizeBtn.style.display = "inline-block";
          }
          // ... (PDF link loading code remains the same below)

          // PDF link
          fetch(`bio/${folderId}/book.pdf`, {method:'HEAD'})
            .then(res=>{
              if(res.ok){
                const pdfDiv = document.getElementById('pdf-link');
                pdfDiv.innerHTML = `<a href="bio/${folderId}/book.pdf" target="_blank">Скачать книгу "Точка отсчета" Николая Лапцевича</a>`;
                pdfDiv.style.marginTop="15px";
                pdfDiv.style.fontWeight="bold";
                pdfDiv.style.color="#0066cc";
              }
            }).catch(()=>{});
        });

      // Toggle image size (grid vs large)
      toggleImageSizeBtn.addEventListener("click", () => {
        largeImages = !largeImages;
        bioImagesDiv.classList.toggle("large", largeImages);
        bioImagesDiv.classList.toggle("small", !largeImages);
        toggleImageSizeBtn.textContent = largeImages ? "Уменьшить изображения" : "Увеличить изображения";
      });

      // Mini-tree
      loadMiniTree(allPeople, personId);
      function loadMiniTree(familyData, highlightId){
        const svg=d3.select("#mini-tree");
        svg.selectAll("*").remove();
        const g = svg.append("g");
        const width = +svg.attr("width")||300;
        const height = +svg.attr("height")||200;

        const orderScript = document.createElement("script");
        orderScript.src = "data/manual_order_regrouped.js";
        const coordsScript = document.createElement("script");
        coordsScript.src = "data/final_x_coordinates.js";
        let orderLoaded=false, coordsLoaded=false;
        const tryBuild=()=>{
          if(!orderLoaded||!coordsLoaded) return;
          if(typeof manualOrderFull==="undefined"||typeof finalXCoordinates==="undefined") return;

          const scaleX=d3.scaleLinear()
            .domain([d3.min(Object.values(finalXCoordinates).flat()), d3.max(Object.values(finalXCoordinates).flat())])
            .range([10,width-10]);

          const genGroups=d3.group(familyData,d=>+d.Generation);
          genGroups.forEach((nodes,gen)=>{
            const orderedIds=manualOrderFull[gen];
            const coords=finalXCoordinates[gen];
            if(!orderedIds||!coords) return;
            for(let i=0;i<Math.min(orderedIds.length,coords.length);i++){
              const id=orderedIds[i];
              const p=nodes.find(n=>n.PersonID.toString()===id.toString());
              if(!p) continue;
              p.x=scaleX(coords[i]);
              p.y=+p.Generation*20+10;
            }
          });

          // Partner lines
          familyData.forEach(p=>{
            if(!p.PartnerID) return;
            p.PartnerID.toString().split(",").map(pid=>pid.trim()).forEach(pid=>{
              const partner=familyData.find(f=>f.PersonID.toString()===pid);
              if(!partner||p.PersonID>=partner.PersonID) return;
              g.append("line").attr("x1",p.x).attr("y1",p.y).attr("x2",partner.x).attr("y2",partner.y)
                .attr("stroke","#888").attr("stroke-width",1);
            });
          });

          // Parent→child lines
          const families={};
          familyData.forEach(child=>{
            const fatherID=child.FatherID||"", motherID=child.MotherID||"";
            if(!fatherID&&!motherID) return;
            const key=`${fatherID}_${motherID}`;
            if(!families[key]) families[key]=[];
            families[key].push(child);
          });
          Object.entries(families).forEach(([key,children])=>{
            const [fatherID,motherID]=key.split("_");
            const parents=[];
            if(fatherID){ const f=familyData.find(p=>p.PersonID.toString()===fatherID); if(f) parents.push(f);}
            if(motherID){ const m=familyData.find(p=>p.PersonID.toString()===motherID); if(m) parents.push(m);}
            if(parents.length===0) return;
            const midX=d3.mean(parents,d=>d.x);
            const midY=d3.mean(parents,d=>d.y);
            children.forEach(child=>g.append("line").attr("x1",midX).attr("y1",midY)
              .attr("x2",child.x).attr("y2",child.y).attr("stroke","#ccc").attr("stroke-width",1));
          });

          g.selectAll("circle").data(familyData).enter().append("circle")
            .attr("cx",d=>d.x).attr("cy",d=>d.y)
            .attr("r",d=>d.PersonID.toString()===highlightId?5:3)
            .attr("fill",d=>d.PersonID.toString()===highlightId?"red":"#555");

          adjustMiniTreePosition();
        };
        orderScript.onload=()=>{ orderLoaded=true; tryBuild(); };
        coordsScript.onload=()=>{ coordsLoaded=true; tryBuild(); };
        document.head.appendChild(orderScript);
        document.head.appendChild(coordsScript);

        function adjustMiniTreePosition(){
          const miniTree=document.getElementById("mini-tree");
          const bio=document.querySelector(".bio");
          const miniTreeWidth=300;
          const bioRect=bio.getBoundingClientRect();
          if(bioRect.right+miniTreeWidth+20>window.innerWidth){
            miniTree.style.position="static";
            miniTree.style.margin="20px auto";
            miniTree.style.width=miniTreeWidth+"px";
            miniTree.style.height="200px";
          } else {
            miniTree.style.position="fixed";
            miniTree.style.top="10px";
            miniTree.style.right="10px";
            miniTree.style.width=miniTreeWidth+"px";
            miniTree.style.height="200px";
            miniTree.style.margin="0";
          }
        }
        window.addEventListener("resize",adjustMiniTreePosition);
      }

    })
    .catch(err=>{ console.error(err); document.body.innerHTML="<h2>Error loading person data.</h2>"; });
});
</script>


<!-- Floating feedback button and Google Form panel -->
<style>
  /* Floating feedback button */
  #feedback-button {
    position: fixed;
    right: 20px;
    bottom: 20px;
    padding: 12px 18px;
    border-radius: 12px;
    background: #e0e0e0;
    color: #333;
    border: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: background 0.3s, transform 0.2s;
    z-index: 1000;
  }
  #feedback-button:hover { background: #d6d6d6; transform: scale(1.05); }

  /* Slide-up form panel */
  #feedback-panel {
    position: fixed;
    right: 20px;
    bottom: 90px;
    width: 400px;
    height: 0;
    overflow: hidden;
    background: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    transition: height 0.4s ease, opacity 0.3s ease;
    opacity: 0;
    z-index: 999;
    display: flex;
    flex-direction: column;
  }
  #feedback-panel.open { height: 500px; opacity: 1; }

  #feedback-panel header {
    background: #f1f1f1;
    color: #333;
    text-align: center;
    padding: 10px;
    font-weight: bold;
    border-bottom: 1px solid #ddd;
    position: relative;
  }

  #close-panel {
    position: absolute;
    right: 10px;
    top: 6px;
    background: transparent;
    border: none;
    font-size: 18px;
    color: #666;
    cursor: pointer;
  }
  #close-panel:hover { color: #000; }

  #feedback-panel iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 0 0 12px 12px;
    flex-grow: 1;
  }
</style>

<button id="feedback-button">Отзыв</button>

<div id="feedback-panel">
  <header>
    <button id="close-panel">×</button>
  </header>
  <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScGlWKhuRktkKVo_qSAufGOwmw2RXI3VkwIngWsmsPuLMByLg/viewform?embedded=true">
    Loading…
  </iframe>
</div>

<script>
  const panel = document.getElementById('feedback-panel');
  const button = document.getElementById('feedback-button');
  const closeBtn = document.getElementById('close-panel');

  button.addEventListener('click', () => panel.classList.toggle('open'));
  closeBtn.addEventListener('click', () => panel.classList.remove('open'));
</script>


</body>
</html>

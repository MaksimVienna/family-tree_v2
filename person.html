<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Person Details</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    background-color: #fafafa;
    color: #222;
  }
  h1 { text-align: center; margin-bottom: 0.2em; }
  .info, .bio {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  img.main-photo { display: block; margin: 20px auto; max-width: 200px; border-radius: 50%; border: 3px solid #ccc; }
  .gallery img {
  display: block;
  max-width: 100%;      /* scale down if too wide */
  height: auto;         /* keep aspect ratio */
  margin: 10px auto;    /* center each image */
  border-radius: 8px;
  border: 1px solid #ddd;
}

  /* Mini-tree CSS */
  #mini-tree {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 300px;
    height: 200px;
    border: 1px solid #ccc;
    background: #fafafa;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<h1 id="name">Loading...</h1>
<img id="main-photo" class="main-photo" src="" alt="Photo">

<div class="info" id="info"></div>

<div class="bio">
  <h2>Biography</h2>
  <div id="bio-text">Loading...</div>
  <div class="gallery" id="bio-images"></div>
</div>

<!-- Mini family tree -->
<svg id="mini-tree"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const folderId = params.get('id');
  if (!folderId) { document.body.innerHTML = "<h2>No person ID specified.</h2>"; return; }

  const personIdMatch = folderId.match(/^id(\d+)/);
  const personId = personIdMatch ? personIdMatch[1] : null;
  if (!personId) { document.body.innerHTML = "<h2>Invalid person ID.</h2>"; return; }

  fetch('data/family_data.json')
    .then(res => res.json())
    .then(allPeople => {
      const person = allPeople.find(p => p.PersonID.toString() === personId);
      if (!person) { document.body.innerHTML = `<h2>No person with ID ${personId} found.</h2>`; return; }

      // Header and photo
      document.getElementById('name').textContent = `${person["Name-ru"] || person.Name} ${person["LastName-ru"] || ""}`;
      const mainPhoto = document.getElementById('main-photo');
      mainPhoto.src = person.Photo && person.Photo !== "" ? `images/${person.Photo}` : "https://placehold.co/200x200?text=No+Photo";

      // Info box
      document.getElementById('info').innerHTML = `
        <p><strong>Birth:</strong> ${person.BirthDate || "—"} (${person.PlaceBirth || "Unknown"})</p>
        <p><strong>Current place:</strong> ${person.PlaceNow || "—"}</p>
        <p><strong>About:</strong> ${person.About || "—"}</p>
        <p><strong>Gender:</strong> ${person.Gender || "—"}</p>
        <p><strong>Father ID:</strong> ${person.FatherID || "—"} | <strong>Mother ID:</strong> ${person.MotherID || "—"}</p>
        <p><strong>Partner(s):</strong> ${person.PartnerID || "—"}</p>
        <p><strong>Children:</strong> ${person.ChildID || "—"}</p>
      `;

      // Biography
      fetch(`../bio/${folderId}/${folderId}.txt`)
        .then(resp => resp.ok ? resp.text() : "")
        .then(txt => { document.getElementById('bio-text').textContent = txt || "No biography text available."; })
        .catch(() => { document.getElementById('bio-text').textContent = "No biography text found."; });

      // Gallery images
      const imgDiv = document.getElementById('bio-images');
      const galleryImages = person.Other_photo ? person.Other_photo.split(",").map(s => s.trim()).filter(s => s).map(f => `../bio/${folderId}/${f}`) : [];
      imgDiv.innerHTML = galleryImages.length === 0 ? "<p>No additional images.</p>" : galleryImages.map(f => `<img src="${f}" alt="">`).join("");

      // --- Mini tree ---
      loadMiniTree(allPeople, personId);
    })
    .catch(err => { console.error(err); document.body.innerHTML = "<h2>Error loading person data.</h2>"; });

  // --- Mini-tree function ---
  function loadMiniTree(familyData, highlightId) {
    const svg = d3.select("#mini-tree");
    svg.selectAll("*").remove();
    const g = svg.append("g");
    const width = +svg.attr("width") || 300;
    const height = +svg.attr("height") || 200;

    const orderScript = document.createElement("script");
    orderScript.src = "data/manual_order_regrouped.js";
    const coordsScript = document.createElement("script");
    coordsScript.src = "data/final_x_coordinates.js";

    let orderLoaded = false, coordsLoaded = false;

    const tryBuild = () => {
      if (!orderLoaded || !coordsLoaded) return;
      if (typeof manualOrderFull === "undefined" || typeof finalXCoordinates === "undefined") return;

      const scaleX = d3.scaleLinear()
        .domain([d3.min(Object.values(finalXCoordinates).flat()), d3.max(Object.values(finalXCoordinates).flat())])
        .range([10, width - 10]);

      const genGroups = d3.group(familyData, d => d.Generation);
      genGroups.forEach((nodes, gen) => {
        const orderedIds = manualOrderFull[gen];
        const coords = finalXCoordinates[gen];
        if (!orderedIds || !coords) return;
        for (let i = 0; i < Math.min(orderedIds.length, coords.length); i++) {
          const id = orderedIds[i];
          const p = nodes.find(n => n.PersonID.toString() === id.toString());
          if (!p) continue;
          p.x = scaleX(coords[i]);
          p.y = +p.Generation * 20 + 10;
        }
      });

      // Partner lines
      familyData.forEach(p => {
        if (!p.PartnerID) return;
        p.PartnerID.toString().split(",").map(pid => pid.trim()).forEach(pid => {
          const partner = familyData.find(f => f.PersonID.toString() === pid);
          if (!partner || p.PersonID >= partner.PersonID) return;
          g.append("line").attr("x1", p.x).attr("y1", p.y).attr("x2", partner.x).attr("y2", partner.y)
            .attr("stroke", "#888").attr("stroke-width", 1);
        });
      });

      // Parent → child lines
      const families = {};
      familyData.forEach(child => {
        const fatherID = child.FatherID || "";
        const motherID = child.MotherID || "";
        if (!fatherID && !motherID) return;
        const key = `${fatherID}_${motherID}`;
        if (!families[key]) families[key] = [];
        families[key].push(child);
      });
      Object.entries(families).forEach(([key, children]) => {
        const [fatherID, motherID] = key.split("_");
        const parents = [];
        if (fatherID) { const f = familyData.find(p => p.PersonID.toString() === fatherID); if (f) parents.push(f); }
        if (motherID) { const m = familyData.find(p => p.PersonID.toString() === motherID); if (m) parents.push(m); }
        if (parents.length === 0) return;
        const midX = d3.mean(parents, d => d.x);
        const midY = d3.mean(parents, d => d.y);
        children.forEach(child => g.append("line").attr("x1", midX).attr("y1", midY)
          .attr("x2", child.x).attr("y2", child.y).attr("stroke", "#ccc").attr("stroke-width", 1));
      });

      // Nodes
      g.selectAll("circle").data(familyData).enter().append("circle")
        .attr("cx", d => d.x).attr("cy", d => d.y)
        .attr("r", d => d.PersonID.toString() === highlightId ? 5 : 3)
        .attr("fill", d => d.PersonID.toString() === highlightId ? "red" : "#555");
    };

    orderScript.onload = () => { orderLoaded = true; tryBuild(); };
    coordsScript.onload = () => { coordsLoaded = true; tryBuild(); };
    document.head.appendChild(orderScript);
    document.head.appendChild(coordsScript);
  }

});
</script>

</body>
</html>

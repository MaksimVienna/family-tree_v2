name: Deploy Static Website with Yandex CLI

# ----------------------------------------------------------------------
# Trigger: Runs the workflow when code is pushed to the 'main' branch
# ----------------------------------------------------------------------

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ----------------------------------------------------------------------
# Jobs
# ----------------------------------------------------------------------

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout: Fetches the code from the repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Setup Tools - Install Yandex CLI, MinIO Client (mc), and jq
      - name: Install Deployment Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Install Yandex Cloud CLI (yc)
          curl -sS https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

          # Install MinIO Client (mc)
          curl -sS https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc

      # 3. Deploy using Yandex Cloud CLI (yc)
      - name: Deploy Static Files via Yandex CLI and MinIO Client
        run: |
          # Define variables
          BUCKET_NAME="family-tree-ya"
          ROOT_FOLDER="docs"

          # 3a. Create the credentials file from the GitHub Secret
          echo '${{ secrets.YC_SA_CREDENTIALS }}' > /tmp/sa-credentials.json
          
          # 3b. Configure MC for S3 authentication
          /usr/local/bin/mc alias set s3 --api S3v4 https://storage.yandexcloud.net \
            "$(jq -r '.accessKeyId' /tmp/sa-credentials.json)" \
            "$(jq -r '.secretAccessKey' /tmp/sa-credentials.json)"

          # ------------------------------------------------------------------
          # 3c. Syncing files using mc mirror (Robust Sync) ðŸš€
          # ------------------------------------------------------------------
          echo "Mirroring all files from $ROOT_FOLDER to the bucket root..."
          # mc mirror copies all files recursively and correctly maps:
          # docs/index.html -> s3/bucket/index.html
          # docs/bio/file.txt -> s3/bucket/bio/file.txt
          /usr/local/bin/mc mirror --overwrite --remove $ROOT_FOLDER/ s3/$BUCKET_NAME/

          # ------------------------------------------------------------------
          # 3d. Applying Cache Headers (Set Attributes)
          # ------------------------------------------------------------------
          echo "Setting Content-Type and Cache-Control headers for all synced files..."
          
          # HTML files: Force re-validation for instant updates
          /usr/local/bin/mc find s3/$BUCKET_NAME --name "*.html" \
            | xargs -n 1 /usr/local/bin/mc setattr --recursive \
            --attr "Content-Type=text/html,Cache-Control=no-cache,max-age=0"

          # CSS files: Aggressive caching for performance
          /usr/local/bin/mc find s3/$BUCKET_NAME --name "*.css" \
            | xargs -n 1 /usr/local/bin/mc setattr --recursive \
            --attr "Content-Type=text/css,Cache-Control=public,max-age=31536000,immutable"

          # JS files: Aggressive caching for performance
          /usr/local/bin/mc find s3/$BUCKET_NAME --name "*.js" \
            | xargs -n 1 /usr/local/bin/mc setattr --recursive \
            --attr "Content-Type=application/javascript,Cache-Control=public,max-age=31536000,immutable"

          # JSON files
          /usr/local/bin/mc find s3/$BUCKET_NAME --name "*.json" \
            | xargs -n 1 /usr/local/bin/mc setattr --recursive \
            --attr "Content-Type=application/json,Cache-Control=public,max-age=3600"

          # Note: Folders like 'bio', 'data', 'images' are copied by 'mc mirror' and do not need separate cp commands.
          # Files like PDFs, if they exist at the root, will be handled by the default Content-Type on the bucket.
          
          # ------------------------------------------------------------------
          # 3e. (Optional) Enable static website mode for the bucket
          # ------------------------------------------------------------------
          # Uncomment the following lines to configure the bucket as a static site
          # $HOME/yandex-cloud/bin/yc storage bucket update $BUCKET_NAME \
          #   --website index=index.html,error-document=404.html

          # ------------------------------------------------------------------
          # 3f. Verify metadata
          # ------------------------------------------------------------------
          echo "Verifying metadata for person.html..."
          /usr/local/bin/mc stat s3/$BUCKET_NAME/person.html || echo "person.html not found yet"

      # 4. Post-Upload Confirmation
      - name: Deployment Success
        run: echo "âœ… Successfully deployed static files to Yandex Object Storage."
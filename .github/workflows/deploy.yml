name: Deploy Static Website with Yandex CLI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout: Fetches the code from the repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Setup Tools - Install Yandex CLI, MinIO Client (mc), and jq
      - name: Install Deployment Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq 
          
          # Install Yandex Cloud CLI (yc)
          curl -sS https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

          # Install MinIO Client (mc)
          curl -sS https://dl.minio.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc

      # 3. Deploy using Yandex Cloud CLI (yc)
      - name: Deploy Static Files via Yandex CLI and MinIO Client
        run: |
          # Define variables
          BUCKET_NAME="family-tree-ya"
          ROOT_FOLDER="docs"
          
          # Define file patterns for caching
          # Files that need LONG cache (1 year)
          LONG_CACHE_PATTERNS="*.jpg,*.jpeg,*.png,*.gif,*.svg,*.css,*.js,*.ico,*.woff2,*.ttf,*.pdf,*.mp4"
          # Files that need SHORT cache (5 minutes)
          SHORT_CACHE_PATTERNS="*.html,*.json,*.txt"

          # 3a. Create the credentials file from the GitHub Secret
          echo '${{ secrets.YC_SA_CREDENTIALS }}' > /tmp/sa-credentials.json
          
          # 3b. Configure MC for S3 authentication
          /usr/local/bin/mc alias set s3 --api S3v4 https://storage.yandexcloud.net \
            "$(jq -r '.accessKeyId' /tmp/sa-credentials.json)" \
            "$(jq -r '.secretAccessKey' /tmp/sa-credentials.json)"

          # ------------------------------------------------------------------
          # 3c. STEP 1: CLEANUP (Remove ALL existing bucket contents) ‚ö†Ô∏è
          # ------------------------------------------------------------------
          echo "STEP 1: Deleting all existing contents from s3/$BUCKET_NAME/ for a clean deployment..."
          /usr/local/bin/mc rm --recursive --force s3/$BUCKET_NAME/ || true

          # ------------------------------------------------------------------
          # 3d. STEP 2: FULL DEPLOYMENT (Initial Copy) üöÄ
          # ------------------------------------------------------------------
          echo "STEP 2: Copying ALL contents of $ROOT_FOLDER/ to bucket root s3/$BUCKET_NAME/."
          # Upload everything first. Content-Type will be set correctly.
          # We don't set Cache-Control here to avoid overwriting it later.
          /usr/local/bin/mc cp --recursive $ROOT_FOLDER/ s3/$BUCKET_NAME/

          # ------------------------------------------------------------------
          # 3e. STEP 3: Apply LONG CACHE (1 Year) to Static Assets üì∏
          # ------------------------------------------------------------------
          echo "STEP 3: Setting 1-year Cache-Control on static assets ($LONG_CACHE_PATTERNS)."
          # Use mc find to locate the files, then pipe the list to xargs to run mc cp on each.
          /usr/local/bin/mc find s3/$BUCKET_NAME/ \
            --name "{${LONG_CACHE_PATTERNS}}" | xargs -I {} \
            /usr/local/bin/mc cp {} {} --attr Cache-Control="max-age=31536000, public, immutable"

          # ------------------------------------------------------------------
          # 3f. STEP 4: Apply SHORT CACHE (5 Minutes) to HTML/JSON üìÑ
          # ------------------------------------------------------------------
          echo "STEP 4: Setting 5-minute Cache-Control on HTML/JSON ($SHORT_CACHE_PATTERNS)."
          # Use mc find to locate the files, then pipe the list to xargs to run mc cp on each.
          /usr/local/bin/mc find s3/$BUCKET_NAME/ \
            --name "{${SHORT_CACHE_PATTERNS}}" | xargs -I {} \
            /usr/local/bin/mc cp {} {} --attr Cache-Control="max-age=300, public, must-revalidate"
          
          # ------------------------------------------------------------------
          # 3g. STEP 5: SET PUBLIC POLICY
          # ------------------------------------------------------------------
          echo "STEP 5: Setting public download policy on the bucket."
          /usr/local/bin/mc policy set download s3/$BUCKET_NAME

          # ------------------------------------------------------------------
          # 3h. STEP 6: Enable static website mode
          # ------------------------------------------------------------------
          echo "STEP 6: Configuring bucket for static website hosting (index.html, 404.html)..."
          $HOME/yandex-cloud/bin/yc storage bucket update $BUCKET_NAME \
            --website index=index.html,error-document=404.html || true

      # 4. Post-Upload Confirmation
      - name: Deployment Success
        run: echo "‚úÖ Successfully performed clean deployment with optimized caching policies."
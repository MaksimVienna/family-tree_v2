name: Deploy Static Website with Yandex CLI

# ----------------------------------------------------------------------
# Trigger: Runs the workflow when code is pushed to the 'main' branch
# ----------------------------------------------------------------------
on:
  push:
    branches:
      - main
  workflow_dispatch:

# ----------------------------------------------------------------------
# Jobs
# ----------------------------------------------------------------------
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout: Fetches the code from the repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Setup Tools - Install Yandex CLI and JSON parser (jq)
      # This step is critical as it installs the missing 'yc' command.
      - name: Install Yandex CLI and Dependencies
        run: |
          # Install 'jq' for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Install Yandex Cloud CLI (yc)
          curl -sS https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          
          # Add the installation path to the PATH environment variable
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      # 3. Deploy using Yandex Cloud CLI (yc)
      # This step executes the deployment logic in a single shell session
      - name: Deploy Static Files via Yandex CLI and MinIO Client
        run: |
          # 3a. Create the credentials file from the GitHub Secret
          # The entire single-line JSON secret is safely written to a temp file.
          echo '${{ secrets.YC_SA_CREDENTIALS }}' > /tmp/sa-credentials.json
          
          # 3b. Configure Yandex CLI with the credentials
          yc config profile create github-deployment
          yc config set access-key-id "$(jq -r '.accessKeyId' /tmp/sa-credentials.json)"
          yc config set secret-access-key "$(jq -r '.secretAccessKey' /tmp/sa-credentials.json)"
          yc config set storage-endpoint "https://storage.yandexcloud.net"

          # 3c. Set the MinIO/S3 Host Environment Variable (used by the 'mc' command)
          export MC_HOST_s3="https://$(jq -r '.accessKeyId' /tmp/sa-credentials.json):$(jq -r '.secretAccessKey' /tmp/sa-credentials.json)@storage.yandexcloud.net"

          # 3d. Clear the bucket (equivalent to clear: true)
          # WARNING: Replace 'YOUR-BUCKET-NAME' with your actual bucket name!
          BUCKET_NAME="family-tree-ya" 
          echo "Clearing existing content in bucket: $BUCKET_NAME"
          /usr/bin/mc rm --recursive --force s3/$BUCKET_NAME || true

          # 3e. Upload files recursively 
          # WARNING: Replace 'docs/' with the correct path to your files!
          ROOT_FOLDER="docs/"
          echo "Uploading files from $ROOT_FOLDER to $BUCKET_NAME"
          /usr/bin/mc cp --recursive --attr 'Content-Type=text/html;Content-Type=text/css;Content-Type=application/javascript;Cache-Control=max-age=300' $ROOT_FOLDER s3/$BUCKET_NAME/

      # 4. Post-Upload Confirmation
      - name: Deployment Success
        run: echo "Successfully deployed static files to Yandex Object Storage."